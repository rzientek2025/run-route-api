<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Pętli Pieszych</title>
    
    <!-- Ładowanie Google Maps JS API z kluczem i biblioteką geometry -->
    <!-- UWAGA: Zastąp TWÓJ_KLUCZ_API własnym kluczem. Nie używaj klucza Google Geocoding/Directions API tutaj! -->
    <script defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOoFkW8KiYgP86c4I2kz5ODr5i4P0GlkI&callback=initMap&libraries=geometry&loading=async">
    </script>
    
    <style>
        /* Ustawienie czcionki, która wspiera polskie znaki */
        body { font-family: 'Arial', 'Helvetica Neue', Arial, sans-serif; margin: 0; background-color: #f4f4f9; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px 0; }
        
        .container { 
            width: 100%;
            max-width: 900px; 
            margin: auto; 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.15); 
        }
        
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        
        /* Sekcja formularza i mapy */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr 1.5fr; /* Więcej miejsca dla mapy na desktopach */
            }
        }

        .form-section {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
        }

        label { display: block; margin-top: 15px; font-weight: 600; color: #34495e; }
        
        /* Kontener dla pola adresu i przycisków */
        .input-group { position: relative; display: flex; align-items: center; margin-top: 5px; }

        .input-group input[type="text"] {
            flex-grow: 1;
        }

        .input-group-buttons {
            display: flex;
            gap: 5px; /* Odstęp między przyciskami */
            margin-left: 10px;
            flex-shrink: 0;
        }
        
        input[type="text"], input[type="number"], select { 
            padding: 12px; 
            border: 1px solid #bdc3c7; 
            border-radius: 6px; 
            box-sizing: border-box; 
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }

        /* Styl dla przycisku Lokalizacji */
        .input-group button {
            padding: 12px 15px;
            width: auto; 
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            line-height: 1; /* Ujednolicenie wysokości */
        }
        
        #use-location-btn {
             background-color: #2ecc71; /* Zielony kolor */
        }
        #use-location-btn:hover {
            background-color: #27ae60;
        }
        
        /* NOWY STYL DLA PRZYCISKU ZAZNACZANIA */
        #mark-point-btn {
             background-color: #3498db; /* Niebieski kolor */
        }
        #mark-point-btn:hover {
            background-color: #2980b9;
        }


        .input-group button:active {
            transform: scale(0.98);
        }


        button.main-action { 
            display: block; width: 100%; padding: 15px; margin-top: 30px; 
            background-color: #3498db; color: white; border: none; border-radius: 6px; 
            cursor: pointer; font-size: 18px; font-weight: bold;
            transition: background-color 0.3s;
        }
        button.main-action:hover { background-color: #2980b9; }
        
        /* Styl dla stanu ładowania przycisku głównego */
        button.main-action.loading {
            background-color: #f39c12; /* Żółty/Pomarańczowy dla ładowania */
            cursor: not-allowed;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(243, 156, 18, 0); }
            100% { box-shadow: 0 0 0 0 rgba(243, 156, 18, 0); }
        }

        /* Sekcja Wyników */
        #results-container {
             margin-top: 20px; 
             grid-column: 1 / -1; /* Rozciągnij na całą szerokość */
        }

        #results { 
            padding: 15px; 
            background-color: #ecf0f1; 
            border-radius: 8px; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            font-size: 14px;
            min-height: 50px;
            border: 1px solid #bdc3c7;
        }

        .message-box {
            padding: 10px;
            border-radius: 4px;
            margin-top: 5px;
        }

        .error { color: #c0392b; font-weight: bold; background-color: #fbdada; border: 1px solid #c0392b; }
        .success { color: #27ae60; font-weight: bold; background-color: #e9f7ef; border: 1px solid #27ae60; }
        .info { color: #34495e; background-color: #f0f3f5; }
        .loading { color: #f39c12; font-weight: bold; background-color: #fdf5e6; border: 1px solid #f39c12; }

        /* Sekcja Mapy */
        #map {
            height: 400px; 
            width: 100%;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Generator Pętli Pieszych </h1>

        <div class="content-grid">
            <div class="form-section">
                
                <label for="api-url">Adres URL API (Backend):</label>
                <input type="text" id="api-url" value="https://run-route-app-kxfys.ondigitalocean.app/api/routes/generate" placeholder="np. http://localhost:8080/routes/generate">
                
                <label for="origin">1. Punkt Startowy (Adres lub Współrzędne Lat,Lng):</label>
                <div class="input-group">
                    <input type="text" id="origin" value="Plac Defilad 1, Warszawa" placeholder="np. Plac Defilad 1, Warszawa lub 52.23,21.01"> 
                    
                    <div class="input-group-buttons">
                        <!-- ISTNIEJĄCY PRZYCISK LOKALIZACJA -->
                        <button id="use-location-btn" onclick="useCurrentLocation()" title="Użyj obecnej lokalizacji">
                                Lokalizacja
                        </button>

                        <!-- NOWY PRZYCISK ZAZNACZANIA PUNKTU -->
                        <button id="mark-point-btn" onclick="markStartPoint()" title="Zaznacz punkt na mapie">
                            Zaznacz
                        </button>
                    </div>
                </div>

                <label for="distance">2. Docelowy Dystans Pętli (km):</label>
                <input type="number" id="distance" value="10" placeholder="np. 10" min="1">

                <label for="direction">3. Opcjonalny Kierunek Początkowy:</label>
                <select id="direction">
                    <option value="">(Dowolny kierunek)</option>
                    <option value="N">Północ (N)</option>
                    <option value="E">Wschód (E)</option>
                    <option value="S">Południe (S)</option>
                    <option value="W">Zachód (W)</option>
                </select>
                
                <button class="main-action" id="generate-btn" onclick="generateRoute()">4. Wyznacz Trasę Pętli</button>
            </div>

            <div class="map-section">
                <div id="map"></div>
            </div>
        </div>

        <div id="results-container">
            <h2>Wyniki i Status:</h2>
            <div id="results" class="message-box info">Czekam na dane. Wprowadź dane i kliknij "Wyznacz Trasę Pętli".</div>
        </div>
    </div>

    <script>
        let map; 
        let routePolyline; 
        let startMarker; 
        let geocoder; // Zmienna do obsługi geokodowania

        // Funkcja do dynamicznego wyświetlania komunikatów
        function displayMessage(type, text) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.classList.remove('error', 'success', 'info', 'loading');
            resultsDiv.classList.add(type);
            
            // W przypadku błędu lub ładowania pokazujemy tylko komunikat
            if (type === 'error' || type === 'loading' || type === 'info') {
                resultsDiv.innerHTML = text;
            } else if (type === 'success') {
                // Dla sukcesu, oczekujemy obiektu zawierającego szczegóły trasy
                resultsDiv.innerHTML = `
                    <p><strong>STATUS:</strong> Sukces</p>
                    <p><strong>Wyznaczony dystans:</strong> ${text.distance_km} km</p>
                    <p><strong>Wiadomość:</strong> ${text.message}</p>
                    <p style="font-size: 0.8em; opacity: 0.7;">Poliline: ${text.polyline.substring(0, 50)}... [${text.polyline.length} znaków]</p>
                `;
            } else { // info/default
                resultsDiv.innerHTML = text;
            }
        }

        /**
         * Ustawia znacznik startowy na mapie i wyśrodkowuje widok.
         * @param {google.maps.LatLngLiteral} latLng - Współrzędne do ustawienia.
         * @param {string} title - Tytuł markera.
         */
        function setMapMarker(latLng, title) {
            if (!map || !startMarker) return;

            startMarker.setPosition(latLng);
            startMarker.setMap(map);
            startMarker.setTitle(title);
            map.setCenter(latLng);
            map.setZoom(14); // Przybliżenie, żeby widzieć punkt
        }

        // Funkcja do geokodowania adresu lub współrzędnych i zaznaczenia punktu
        function markStartPoint() {
            if (!map || !geocoder) {
                displayMessage('error', "BŁĄD: Mapa lub usługa Geocoding nie jest jeszcze gotowa.");
                return;
            }

            const origin = document.getElementById('origin').value.trim();
            if (!origin) {
                displayMessage('error', 'BŁĄD: Punkt startowy nie może być pusty.');
                return;
            }

            // 1. Sprawdzenie, czy to są współrzędne (Lat,Lng)
            const coordsMatch = origin.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
            
            if (coordsMatch) {
                const lat = parseFloat(coordsMatch[1]);
                const lng = parseFloat(coordsMatch[2]);
                const latLng = { lat, lng };

                // Walidacja podstawowa
                if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                    setMapMarker(latLng, "Punkt Startowy (Współrzędne)");
                    displayMessage('info', `Zaznaczono punkt startowy na mapie (Współrzędne): ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                    return;
                }
            }

            // 2. Jeśli to nie współrzędne, użyj Geokodera do znalezienia adresu
            displayMessage('info', `Szukanie adresu: "${origin}"...`);

            geocoder.geocode({ 'address': origin }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    const latLng = { lat: location.lat(), lng: location.lng() };

                    setMapMarker(latLng, results[0].formatted_address);
                    displayMessage('info', `Znaleziono i zaznaczono punkt startowy: ${results[0].formatted_address}`);
                } else {
                    displayMessage('error', `BŁĄD: Nie udało się zlokalizować "${origin}". Status: ${status}. Sprawdź, czy klucz API jest poprawny.`);
                }
            });
        }


        // Funkcja inicjalizująca mapę (wywoływana przez API Google)
        function initMap() {
            const defaultCenter = { lat: 52.23, lng: 21.01 }; // Warszawa
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                zoom: 12,
            });

            // Inicjalizacja Geocodera
            geocoder = new google.maps.Geocoder();

            // Marker startowy
            startMarker = new google.maps.Marker({
                position: defaultCenter,
                map: map,
                title: "Punkt Startowy",
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                }
            });
            console.log("Mapa została zainicjowana!");
        }

        // Funkcja usuwająca starą trasę
        function clearRoute() {
            if (routePolyline) {
                routePolyline.setMap(null);
                routePolyline = null;
            }
        }
        
        function drawRoute(encodedPolyline, startPoint) {
            if (!map || !google.maps.geometry) {
                 displayMessage('error', "BŁĄD: Mapa lub biblioteka geometry jest niedostępna. Upewnij się, że klucz API jest poprawny.");
                 return;
            }
            
            clearRoute(); 

            // Dekodowanie i rysowanie trasy
            const path = google.maps.geometry.encoding.decodePath(encodedPolyline);
            routePolyline = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: '#e74c3c', /* Czerwony */
                strokeOpacity: 1.0,
                strokeWeight: 5
            });

            routePolyline.setMap(map);

            // Aktualizacja markera startowego
            const actualStartPoint = path.length > 0 ? path[0] : startPoint;
            setMapMarker(actualStartPoint, "Start pętli");
            
            // Dopasowanie widoku mapy
            const bounds = new google.maps.LatLngBounds();
            for (let i = 0; i < path.length; i++) {
                bounds.extend(path[i]);
            }
            map.fitBounds(bounds);
        }

        // Funkcja do obsługi geolokalizacji
        function useCurrentLocation() {
            const originInput = document.getElementById('origin');
            displayMessage('info', 'Pobieranie obecnej lokalizacji. Proszę zezwolić przeglądarce na dostęp...');

            if (!navigator.geolocation) {
                displayMessage('error', 'BŁĄD: Twoja przeglądarka nie wspiera geolokalizacji. Wprowadź adres ręcznie.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    
                    const coordsString = `${lat}, ${lng}`;
                    originInput.value = coordsString;
                    
                    // Przesuń mapę i marker do nowej lokalizacji
                    const currentLatLng = { lat: parseFloat(lat), lng: parseFloat(lng) };
                    setMapMarker(currentLatLng, "Twoja obecna lokalizacja");

                    displayMessage('info', `Lokalizacja ustawiona na: ${coordsString}. Kliknij "Wyznacz Trasę Pętli".`);
                },
                (error) => {
                    let errorMessage;
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage = "BŁĄD: Odmowa dostępu do geolokalizacji. Wprowadź adres ręcznie.";
                    } else {
                        errorMessage = `BŁĄD: Geolokalizacja nie powiodła się. ${error.message}.`;
                    }
                    displayMessage('error', errorMessage);
                }
            );
        }


        // Główna funkcja wyznaczająca trasę
        async function generateRoute() {
            const generateBtn = document.getElementById('generate-btn');
            
            if (generateBtn.classList.contains('loading')) return; // Zabezpieczenie przed wielokrotnym kliknięciem

            const apiUrlElement = document.getElementById('api-url');
            const apiUrl = apiUrlElement.value;
            const origin = document.getElementById('origin').value.trim();
            const distance = document.getElementById('distance').value;
            const direction = document.getElementById('direction').value; 
            
            // Walidacja
            if (isNaN(parseFloat(distance)) || parseFloat(distance) <= 0) {
                displayMessage('error', 'BŁĄD: Dystans musi być liczbą większą niż 0.');
                return;
            }
            if (!origin) {
                displayMessage('error', 'BŁĄD: Punkt startowy nie może być pusty.');
                return;
            }
            
            generateBtn.classList.add('loading');
            generateBtn.textContent = 'Trwa szukanie trasy...';
            displayMessage('loading', "Wysyłam zapytanie do API i szukam najlepszej trasy. Może to potrwać kilka sekund...");
            clearRoute(); 

            try {
                // Konwersja z km na metry przed wysłaniem do serwera
                const distanceMeters = parseFloat(distance) * 1000;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        origin: origin, 
                        distance: distanceMeters,
                        direction: direction
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // Obsługa błędu zwróconego przez serwer
                    displayMessage('error', `BŁĄD SERWERA: ${data.error || 'Nieznany błąd'}\nSzczegóły: ${data.details || 'Brak'}`);
                    return;
                }

                // Sukces
                displayMessage('success', data);
                
                // Lokalizacja startowa (pobieramy z pola, aby Google Directions mogło ją przetworzyć w drawRoute)
                let startPointLatLng = null; 
                if (origin.includes(',')) {
                    const [lat, lng] = origin.split(',').map(c => parseFloat(c.trim()));
                    if (!isNaN(lat) && !isNaN(lng)) {
                         startPointLatLng = new google.maps.LatLng(lat, lng);
                    }
                }
                
                drawRoute(data.polyline, startPointLatLng);

            } catch (error) {
                displayMessage('error', `BŁĄD SIECI: Nie udało się połączyć z API. Sprawdź konsolę F12, aby zobaczyć szczegóły. Szczegóły: ${error.message}`);
            } finally {
                generateBtn.classList.remove('loading');
                generateBtn.textContent = '4. Wyznacz Trasę Pętli';
            }
        }

        // Inicjalizacja mapy po załadowaniu skryptu Google
        window.initMap = initMap;
        
        // Ustawienie domyślnego stanu komunikatu i przypisanie akcji do nowego przycisku
        document.addEventListener('DOMContentLoaded', () => {
            displayMessage('info', "Wprowadź dane i kliknij 'Wyznacz Trasę Pętli' lub 'Lokalizacja' albo 'Zaznacz' aby zacząć.");

            // Dodanie nasłuchiwania dla nowego przycisku (dla czytelności w JavaScript)
            document.getElementById('mark-point-btn').addEventListener('click', markStartPoint);
        });

    </script>
</body>
</html>
