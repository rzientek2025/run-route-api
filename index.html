<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Pętli Biegowych</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ustawienia widoku i font */
        body { font-family: 'Inter', sans-serif; }
        #map { height: 70vh; width: 100%; border-radius: 0.5rem; margin-top: 1rem; }
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Generator Pętli Biegowych</h1>
            <p class="text-gray-500 mt-2">Wprowadź punkt startowy i docelowy dystans, a my wyznaczymy dla Ciebie idealną pętlę.</p>
        </header>

        <div id="controls" class="bg-white p-6 rounded-xl shadow-lg relative">
            
            <div id="loading-overlay" class="loading-overlay hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 border-t-transparent mb-3"></div>
                <p id="loading-message" class="text-blue-600 font-semibold">Generowanie trasy... (Może potrwać do 10 sekund)</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <div class="col-span-1 md:col-span-2 relative">
                    <label for="origin" class="block text-sm font-medium text-gray-700 mb-1">Adres Startowy / Współrzędne</label>
                    <input type="text" id="origin" value="Plac Piłsudskiego, Warszawa" placeholder="Np. Kraków, Rynek Główny 1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <button id="use-location-btn" class="absolute right-2 top-9 bg-blue-500 text-white p-1 rounded-full hover:bg-blue-600 transition duration-150" title="Użyj obecnej lokalizacji">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                            <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                    </button>
                </div>
                
                <div>
                    <label for="distance" class="block text-sm font-medium text-gray-700 mb-1">Dystans (km)</label>
                    <input type="number" id="distance" value="10" min="1" step="0.5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="col-span-full mt-4">
                    <button id="generate-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 shadow-md">
                        Generuj Pętlę
                    </button>
                </div>
            </div>
            
            <div id="message-panel" class="mt-6 p-3 rounded-lg text-sm hidden" role="alert"></div>

        </div>

        <div id="map"></div>
    </div>

    <script>
        // UWAGA: Stała ścieżka do endpointu API (adres względny)
        const API_ROUTE_URL = '/routes/generate'; 

        // Klucz API Google Maps JS API jest wymagany tutaj:
        // PAMIĘTAJ O ZMIANIE KLUCZA!!!
        const GMAPS_API_KEY = "YOUR_GOOGLE_MAPS_API_KEY"; 
        
        let map;
        let polyline;
        let startMarker; 
        let MarkerElement;

        const originInput = document.getElementById('origin');
        const distanceInput = document.getElementById('distance');
        const generateBtn = document.getElementById('generate-btn');
        const useLocationBtn = document.getElementById('use-location-btn');
        const messagePanel = document.getElementById('message-panel');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');


        // --- FUNKCJE MAPY ---

        async function initMap() {
            // Domyślna lokalizacja (np. Warszawa)
            const defaultLocation = { lat: 52.237, lng: 21.017 }; 
            
            // Wymagana, aby załadować nową klasę markerów
            const { Map } = await google.maps.importLibrary("maps");
            MarkerElement = await google.maps.importLibrary("marker");
            
            map = new Map(document.getElementById("map"), {
                zoom: 12,
                center: defaultLocation,
                mapId: 'DEMO_MAP_ID', // Użyj ID mapy
            });
            
            // Inicjalizacja pustej linii trasy
            polyline = new google.maps.Polyline({
                strokeColor: '#0066FF',
                strokeOpacity: 0.8,
                strokeWeight: 5,
                map: map,
            });
            
            // Inicjalizacja nowego markera
            startMarker = new MarkerElement.AdvancedMarkerElement({
                map: map,
                position: defaultLocation,
                title: "Punkt Startowy"
            });
        }
        
        function updateMap(encodedPolyline, distanceKm, latLng) {
            // Dekodowanie Polylines
            const path = google.maps.geometry.encoding.decodePath(encodedPolyline);
            
            // Aktualizacja linii
            polyline.setPath(path);
            
            // Ustawienie markera startowego
            const startPoint = latLng ? latLng : path[0];
            
            // Używamy nowej metody ustawiania pozycji dla AdvancedMarkerElement
            startMarker.position = startPoint;
            startMarker.map = map; // Upewnienie się, że jest na mapie
            
            // Wyśrodkowanie mapy i dopasowanie granic
            if (path.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                path.forEach(point => bounds.extend(point));
                map.fitBounds(bounds);
            }
        }

        // --- OBSŁUGA BŁĘDÓW/Wiadomości ---

        function displayMessage(type, text) {
            messagePanel.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            messagePanel.innerHTML = text;
            
            if (type === 'error') {
                messagePanel.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                messagePanel.classList.add('bg-green-100', 'text-green-800');
            } else {
                messagePanel.classList.add('bg-blue-100', 'text-blue-800');
            }
        }
        
        function setLoading(isLoading, message = "Generowanie trasy...") {
            if (isLoading) {
                loadingMessage.textContent = message;
                loadingOverlay.classList.remove('hidden');
                generateBtn.disabled = true;
                useLocationBtn.disabled = true;
            } else {
                loadingOverlay.classList.add('hidden');
                generateBtn.disabled = false;
                useLocationBtn.disabled = false;
            }
        }

        // --- LOGIKA GEOLOKALIZACJI ---

        useLocationBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                displayMessage('error', 'Twoja przeglądarka nie wspiera geolokalizacji.');
                return;
            }

            setLoading(true, "Pobieranie obecnej lokalizacji...");
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    setLoading(false);
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);
                    
                    // Wstawienie współrzędnych do pola input
                    originInput.value = `${lat},${lng}`;
                    displayMessage('success', `Lokalizacja ustawiona na: ${lat}, ${lng}.`);
                    
                    // Ustawienie mapy na obecną lokalizację
                    const currentLatLng = { lat: parseFloat(lat), lng: parseFloat(lng) };
                    map.setCenter(currentLatLng);
                    map.setZoom(14); 
                    
                    // Ustawienie markera na obecnej lokalizacji
                    startMarker.position = currentLatLng;
                    startMarker.map = map;

                },
                (error) => {
                    setLoading(false);
                    let errorMessage;
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage = "Odmowa dostępu do geolokalizacji. Wprowadź adres ręcznie.";
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        errorMessage = "Informacja o lokalizacji jest niedostępna.";
                    } else {
                        errorMessage = `Wystąpił nieznany błąd geolokalizacji: ${error.message}`;
                    }
                    displayMessage('error', errorMessage);
                }
            );
        });

        // --- LOGIKA GENEROWANIA TRASY ---

        generateBtn.addEventListener('click', async () => {
            const origin = originInput.value.trim();
            // Konwersja km na metry dla API Node.js
            const distanceKm = parseFloat(distanceInput.value);
            const distanceMeters = distanceKm * 1000; 

            if (!origin || distanceMeters <= 0 || isNaN(distanceMeters)) {
                displayMessage('error', 'Wprowadź poprawny adres startowy i dystans w kilometrach.');
                return;
            }

            setLoading(true);
            displayMessage('default', 'Wysyłanie żądania do serwera...');
            
            // Przygotowanie danych do wysłania
            const requestBody = {
                origin: origin,
                distance: distanceMeters, // wysyłamy w metrach
            };
            
            // Używamy metody GET z Query Parameters
            const params = new URLSearchParams(requestBody).toString();
            const apiUrl = `${API_ROUTE_URL}?${params}`;

            try {
                // Żądanie GET
                const response = await fetch(apiUrl, { 
                    method: 'GET',
                });
                
                // Sprawdzenie, czy odpowiedź ma status OK
                if (!response.ok) {
                    const errorText = await response.text();
                    displayMessage('error', `BŁĄD SERWERA (${response.status}): Serwer zwrócił status błędu. Odpowiedź: ${errorText.substring(0, 100)}...`);
                    return;
                }

                // Sprawdzenie nagłówka Content-Type przed próbą parsowania jako JSON
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const result = await response.json();

                    if (result.error) {
                        // Obsługa błędów zwróconych przez Node.js API
                        const errorDetails = result.details || 'Brak szczegółów błędu.';
                        displayMessage('error', `BŁĄD: ${result.error}. Szczegóły: ${errorDetails}`);
                        return;
                    }

                    // Sukces: Aktualizacja mapy i wyświetlenie wiadomości
                    displayMessage('success', `${result.message} Wyznaczona trasa: ${result.distance_km} km. Zobacz trasę na mapie.`);
                    
                    // Ustalenie lokalizacji startowej na podstawie pierwszej współrzędnej polyline
                    const tempPath = google.maps.geometry.encoding.decodePath(result.polyline);
                    const firstPoint = tempPath[0];
                    const startCoords = { lat: firstPoint.lat(), lng: firstPoint.lng() };

                    updateMap(result.polyline, result.distance_km, startCoords);

                } else {
                     const errorText = await response.text();
                     displayMessage('error', `BŁĄD PARSOWANIA: Oczekiwano JSON, otrzymano ${contentType || 'brak typu'}. Otrzymano nieoczekiwaną odpowiedź. Sprawdź logs serwera.`);
                     console.error("Otrzymana odpowiedź serwera:", errorText.substring(0, 500));
                }

            } catch (error) {
                console.error('Błąd komunikacji z serwerem:', error);
                displayMessage('error', `Błąd komunikacji z API: ${error.message}. Adres: ${apiUrl}. Sprawdź, czy serwer działa i obsługuje GET.`);
            } finally {
                setLoading(false);
            }
        });

        // --- INICJALIZACJA ---
        window.onload = function() {
            // Ładowanie Google Maps JS API (ASYNC)
            const script = document.createElement('script');
            // Dodajemy 'marker' do libraries, 'geometry' i 'async'
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GMAPS_API_KEY}&callback=initMap&libraries=geometry,marker&loading=async`;
            document.head.appendChild(script);

            // Wyświetlenie ostrzeżenia o kluczu
            if (GMAPS_API_KEY === "YOUR_GOOGLE_MAPS_API_KEY") {
                 displayMessage('error', 'KRYTYCZNY BŁĄD KONFIGURACJI: Wymagany jest klucz Google Maps JavaScript API. Wklej go do pliku index.html.');
            } else {
                 displayMessage('default', 'Wprowadź adres i dystans lub użyj geolokalizacji, aby rozpocząć.');
            }
        };

    </script>
</body>
</html>
