<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Pętli Pieszych</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Użycie czcionki wspierającej polskie znaki */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7f9;
        }
        /* Responsywna siatka dla formularza i mapy */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            max-width: 1200px;
            margin: 24px auto;
            padding: 0 16px;
        }
        @media (min-width: 1024px) {
            .content-grid {
                grid-template-columns: 1fr 2fr; /* Formularz 1/3, Mapa 2/3 */
            }
        }
        #map {
            height: 600px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: #e5e5e5;
        }
        .form-card {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .input-group {
            margin-bottom: 16px;
        }
        .button-primary {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .button-primary:hover {
            background-color: #2563eb; /* Blue 600 */
        }
        .button-secondary {
            background-color: #6b7280; /* Gray 500 */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .button-secondary:hover {
            background-color: #4b5563; /* Gray 600 */
        }
        .message-box {
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
        }
        .message-success {
            background-color: #d1fae5; /* Green 100 */
            color: #065f46; /* Green 800 */
        }
        .message-error {
            background-color: #fee2e2; /* Red 100 */
            color: #991b1b; /* Red 800 */
        }
        .message-info {
            background-color: #dbeafe; /* Blue 100 */
            color: #1e40af; /* Blue 800 */
        }
    </style>
</head>
<body>

    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-extrabold text-gray-900">Generator Pętli Pieszych</h1>
            <p class="mt-1 text-sm text-gray-500">Wpisz punkt startowy i pożądany dystans, aby wyznaczyć optymalną pętlę.</p>
        </div>
    </header>

    <div class="content-grid">
        <!-- FORMULARZ STERUJĄCY -->
        <div class="form-card">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Ustawienia trasy</h2>
            
            <div class="input-group">
                <label for="origin" class="block text-sm font-medium text-gray-700 mb-1">1. Punkt Startowy (Adres lub Lat/Lng)</label>
                <div class="flex space-x-2">
                    <input type="text" id="origin" name="origin" placeholder="Np. Dworzec Centralny, Warszawa" class="flex-grow w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <button type="button" class="button-secondary text-sm px-3 py-2 whitespace-nowrap" onclick="geocodeAndSetMarker()">Zaznacz adres</button>
                    <button type="button" class="button-secondary text-sm px-3 py-2 whitespace-nowrap" onclick="useCurrentLocation()">Moja lokalizacja</button>
                </div>
            </div>

            <div class="input-group">
                <label for="distance" class="block text-sm font-medium text-gray-700 mb-1">2. Docelowy Dystans Pętli (km)</label>
                <input type="number" id="distance" name="distance" value="10" min="1" step="0.1" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div class="input-group">
                <label for="direction" class="block text-sm font-medium text-gray-700 mb-1">3. Opcjonalny Kierunek Początkowy</label>
                <select id="direction" name="direction" class="w-full border border-gray-300 p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Losowy</option>
                    <option value="N">Północ (N)</option>
                    <option value="E">Wschód (E)</option>
                    <option value="S">Południe (S)</option>
                    <option value="W">Zachód (W)</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Sugeruje kierunek, w którym pętla powinna się rozszerzyć.</p>
            </div>
            
            <button type="button" class="button-primary w-full mt-4" onclick="generateRoute()">
                Generuj Pętlę Pieszą
            </button>

            <!-- KOMUNIKATY I WYNIKI -->
            <div id="messageContainer" class="message-box message-info mt-4 hidden"></div>

        </div>

        <!-- MAPA -->
        <div id="map"></div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=&callback=initMap" async defer></script>
    <script>
        let map;
        let marker;
        let directionsRenderer;
        let geocoder;
        
        // Funkcja inicjująca mapę (wywoływana przez Google Maps API)
        function initMap() {
            // Inicjalizacja Geocodera
            geocoder = new google.maps.Geocoder();

            // Ustawienia początkowe mapy (Warszawa)
            const defaultLocation = { lat: 52.2297, lng: 21.0122 };

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: defaultLocation,
                mapId: "DEMO_MAP_ID" // Użycie domyślnego ID mapy
            });

            // Renderer trasy
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, polylineOptions: { strokeColor: '#10b981', strokeWeight: 6 } });

            // Znacznik startowy (domyślnie na Warszawie)
            marker = new google.maps.Marker({
                position: defaultLocation,
                map: map,
                title: 'Punkt Startowy'
            });
        }

        // Funkcja wyświetlająca komunikaty
        function displayMessage(status, text, details = '') {
            const container = document.getElementById('messageContainer');
            container.classList.remove('hidden', 'message-success', 'message-error', 'message-info');
            
            container.innerHTML = `<strong>STATUS: ${status}</strong><br>${text}`;
            if (details) {
                container.innerHTML += `<br><br><small>Szczegóły: ${details}</small>`;
            }

            if (status === 'OK') {
                container.classList.add('message-success');
            } else if (status.startsWith('BŁĄD')) {
                container.classList.add('message-error');
            } else {
                container.classList.add('message-info');
            }
        }

        // --- NOWA FUNKCJONALNOŚĆ: GEOKODOWANIE I USTAWIENIE ZNACZNIKA Z ADRESU ---
        function geocodeAndSetMarker() {
            const address = document.getElementById('origin').value;
            if (!address) {
                displayMessage('BŁĄD', 'Wpisz adres lub współrzędne, aby zaznaczyć punkt startowy na mapie.');
                return;
            }

            // Sprawdzenie, czy to już są współrzędne (Lat/Lng)
            const coordsMatch = address.match(/^(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)$/);
            if (coordsMatch) {
                const lat = parseFloat(coordsMatch[1]);
                const lng = parseFloat(coordsMatch[3]);
                const location = { lat: lat, lng: lng };
                
                marker.setPosition(location);
                map.setCenter(location);
                map.setZoom(14);
                displayMessage('INFO', `Punkt startowy ustawiony: ${lat.toFixed(6)}, ${lng.toFixed(6)}.`);
                return;
            }

            // Geokodowanie adresu
            geocoder.geocode({ 'address': address }, (results, status) => {
                if (status === 'OK') {
                    const location = results[0].geometry.location;
                    const formattedAddress = results[0].formatted_address;
                    
                    document.getElementById('origin').value = `${location.lat()}, ${location.lng()}`; // Ustawienie Lat/Lng w polu
                    
                    marker.setPosition(location);
                    map.setCenter(location);
                    map.setZoom(14);
                    displayMessage('INFO', `Punkt startowy zaznaczony na mapie: ${formattedAddress}.`);
                } else {
                    displayMessage('BŁĄD', `Geokodowanie nieudane: ${status}. Sprawdź, czy adres jest poprawny.`);
                }
            });
        }


        // Funkcja używająca geolokalizacji przeglądarki
        function useCurrentLocation() {
            if (navigator.geolocation) {
                displayMessage('INFO', 'Lokalizowanie...', 'Proszę zezwolić przeglądarce na dostęp do Twojej lokalizacji.');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const location = { lat: lat, lng: lng };
                        
                        document.getElementById('origin').value = `${lat}, ${lng}`;
                        
                        // Ustawienie znacznika i wyśrodkowanie mapy
                        marker.setPosition(location);
                        map.setCenter(location);
                        map.setZoom(14);

                        displayMessage('OK', 'Lokalizacja pobrana pomyślnie.', `Współrzędne: ${lat.toFixed(6)}, ${lng.toFixed(6)}.`);
                    },
                    (error) => {
                        displayMessage('BŁĄD', 'Nie udało się pobrać lokalizacji.', `Kod błędu: ${error.code}. Spróbuj wpisać adres ręcznie.`);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                displayMessage('BŁĄD', 'Brak wsparcia dla geolokalizacji.', 'Twoja przeglądarka nie obsługuje API geolokalizacji.');
            }
        }

        // Funkcja generująca trasę (wysyła żądanie do backendu)
        async function generateRoute() {
            const origin = document.getElementById('origin').value;
            const distanceKm = parseFloat(document.getElementById('distance').value);
            const direction = document.getElementById('direction').value;
            
            if (!origin || isNaN(distanceKm) || distanceKm <= 0) {
                displayMessage('BŁĄD', 'Wypełnij poprawnie wszystkie pola.', 'Wpisz punkt startowy i poprawny dystans (km).');
                return;
            }
            
            // Konwersja dystansu z km na metry dla API
            const distanceMeters = distanceKm * 1000; 

            displayMessage('INFO', 'Generowanie pętli...', `Docelowy dystans: ${distanceKm} km. Może to potrwać kilka sekund (do 20 prób).`);

            try {
                // Endpoint do generowania tras w server.js
                const apiUrl = '/routes/generate'; 

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        origin: origin, 
                        distance: distanceMeters,
                        direction: direction
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Sukces
                    displayMessage('OK', result.message, result.details);
                    
                    // Rysowanie trasy
                    const polyline = result.polyline;
                    directionsRenderer.setDirections({
                        routes: [{
                            overview_polyline: { points: polyline },
                            // Ustawienie legs na pustą tablicę lub jeden leg, aby DirectionsRenderer działał
                            legs: [{ start_location: marker.getPosition(), end_location: marker.getPosition() }] 
                        }]
                    });
                    
                    // Wyśrodkowanie mapy na trasie
                    map.fitBounds(new google.maps.geometry.encoding.decodePath(polyline).reduce((bounds, coord) => {
                        return bounds.extend(coord);
                    }, new google.maps.LatLngBounds()));

                } else {
                    // Błąd z serwera
                    displayMessage('BŁĄD SERWERA', result.error, result.details);
                }

            } catch (error) {
                console.error('Błąd połączenia z API:', error);
                displayMessage('BŁĄD POŁĄCZENIA', 'Nie można połączyć się z serwerem API.', error.message);
            }
        }
    </script>
</body>
</html>
