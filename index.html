<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Pętli Biegowych</title>
    <!-- Ładowanie Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ustawienia widoku i font */
        body { font-family: 'Inter', sans-serif; }
        #map { height: 70vh; width: 100%; border-radius: 0.5rem; margin-top: 1rem; }
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Generator Pętli Biegowych</h1>
            <p class="text-gray-500 mt-2">Wprowadź punkt startowy i docelowy dystans, a my wyznaczymy dla Ciebie idealną pętlę.</p>
        </header>

        <div id="controls" class="bg-white p-6 rounded-xl shadow-lg relative">
            
            <!-- Obszar ładowania -->
            <div id="loading-overlay" class="loading-overlay hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 border-t-transparent mb-3"></div>
                <p id="loading-message" class="text-blue-600 font-semibold">Generowanie trasy... (Może potrwać do 10 sekund)</p>
            </div>

            <!-- Formularz -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <!-- Pole Adres Startowy -->
                <div class="col-span-1 md:col-span-2 relative">
                    <label for="origin" class="block text-sm font-medium text-gray-700 mb-1">Adres Startowy</label>
                    <input type="text" id="origin" value="Plac Piłsudskiego, Warszawa" placeholder="Np. Kraków, Rynek Główny 1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Pole Dystans -->
                <div>
                    <label for="distance" class="block text-sm font-medium text-gray-700 mb-1">Dystans (km)</label>
                    <input type="number" id="distance" value="10" min="1" step="0.5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Przycisk Generowania -->
                <div class="col-span-full mt-4">
                    <button id="generate-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-200 shadow-md">
                        Generuj Pętlę
                    </button>
                </div>
            </div>
            
            <!-- Panel Wiadomości/Błędów -->
            <div id="message-panel" class="mt-6 p-3 rounded-lg text-sm hidden" role="alert"></div>

        </div>

        <!-- Mapa -->
        <div id="map"></div>
    </div>

    <script>
        // UWAGA: Stała ścieżka do endpointu API (zgodna z działającą wersją)
        const API_ROUTE_URL = '/routes/generate'; 

        // Klucz API Google Maps JS API jest wymagany tutaj:
        const GMAPS_API_KEY = "AIzaSyAOoFkW8KiYgP86c4I2kz5ODr5i4P0GlkI"; 
        
        let map;
        let polyline;
        let startMarker; 

        const originInput = document.getElementById('origin');
        const distanceInput = document.getElementById('distance');
        const generateBtn = document.getElementById('generate-btn');
        const messagePanel = document.getElementById('message-panel');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');


        // --- FUNKCJE MAPY ---

        function initMap() {
            // Domyślna lokalizacja (np. Warszawa)
            const defaultLocation = { lat: 52.237, lng: 21.017 }; 
            
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 12,
                center: defaultLocation,
                mapId: 'DEMO_MAP_ID',
            });
            
            // Inicjalizacja pustej linii trasy
            polyline = new google.maps.Polyline({
                strokeColor: '#0066FF',
                strokeOpacity: 0.8,
                strokeWeight: 5,
                map: map,
            });
            
            // Marker
            startMarker = new google.maps.Marker({
                map: map,
                position: defaultLocation,
                title: "Punkt Startowy"
            });
        }
        
        function updateMap(encodedPolyline, latLng) {
            // Dekodowanie Polylines
            const path = google.maps.geometry.encoding.decodePath(encodedPolyline);
            
            // Aktualizacja linii
            polyline.setPath(path);
            
            // Ustawienie markera startowego
            const startPoint = latLng ? new google.maps.LatLng(latLng.lat, latLng.lng) : path[0];
            
            startMarker.setPosition(startPoint);
            startMarker.setMap(map);
            
            // Wyśrodkowanie mapy i dopasowanie granic
            if (path.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                path.forEach(point => bounds.extend(point));
                map.fitBounds(bounds);
            }
        }

        // --- OBSŁUGA BŁĘDÓW/Wiadomości ---

        function displayMessage(type, text) {
            messagePanel.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            messagePanel.innerHTML = text;
            
            if (type === 'error') {
                messagePanel.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                messagePanel.classList.add('bg-green-100', 'text-green-800');
            } else {
                messagePanel.classList.add('bg-blue-100', 'text-blue-800');
            }
        }
        
        function setLoading(isLoading, message = "Generowanie trasy...") {
            if (isLoading) {
                loadingMessage.textContent = message;
                loadingOverlay.classList.remove('hidden');
                generateBtn.disabled = true;
            } else {
                loadingOverlay.classList.add('hidden');
                generateBtn.disabled = false;
            }
        }

        // --- LOGIKA GENEROWANIA TRASY (POST) ---

        generateBtn.addEventListener('click', async () => {
            const origin = originInput.value.trim();
            // Konwersja km na metry dla API Node.js
            const distanceKm = parseFloat(distanceInput.value);
            const distanceMeters = distanceKm * 1000; 

            if (!origin || distanceMeters <= 0 || isNaN(distanceMeters)) {
                displayMessage('error', 'Wprowadź poprawny adres startowy i dystans w kilometrach.');
                return;
            }

            setLoading(true);
            displayMessage('default', 'Wysyłanie żądania do serwera...');
            
            try {
                // Żądanie POST do ścieżki /routes/generate
                const response = await fetch(API_ROUTE_URL, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ origin: origin, distance: distanceMeters }),
                });
                
                // Sprawdzenie, czy odpowiedź ma status OK
                if (!response.ok) {
                    const errorText = await response.text();
                    displayMessage('error', `BŁĄD SERWERA (${response.status}): Serwer zwrócił status błędu. Odpowiedź: ${errorText.substring(0, 100)}...`);
                    return;
                }

                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const result = await response.json();

                    if (result.error) {
                        const errorDetails = result.details || 'Brak szczegółów błędu.';
                        displayMessage('error', `BŁĄD: ${result.error}. Szczegóły: ${errorDetails}`);
                        return;
                    }

                    // Sukces: Aktualizacja mapy i wyświetlenie wiadomości
                    displayMessage('success', `${result.message}`);
                    
                    // Ustalenie lokalizacji startowej
                    const tempPath = google.maps.geometry.encoding.decodePath(result.polyline);
                    const firstPoint = tempPath[0];
                    const startCoords = { lat: firstPoint.lat(), lng: firstPoint.lng() }; 

                    updateMap(result.polyline, startCoords);

                } else {
                     const errorText = await response.text();
                     displayMessage('error', `BŁĄD PARSOWANIA: Oczekiwano JSON. Otrzymano nieoczekiwaną odpowiedź. Sprawdź logs serwera.`);
                }

            } catch (error) {
                console.error('Błąd komunikacji z serwerem:', error);
                displayMessage('error', `Błąd komunikacji z API: ${error.message}. Sprawdź, czy serwer działa.`);
            } finally {
                setLoading(false);
            }
        });

        // --- INICJALIZACJA ---
        window.onload = function() {
            // Ładowanie Google Maps JS API
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GMAPS_API_KEY}&callback=initMap&libraries=geometry`;
            document.head.appendChild(script);

            // Wyświetlenie ostrzeżenia o kluczu
            if (GMAPS_API_KEY === "YOUR_GOOGLE_MAPS_API_KEY") {
                 displayMessage('error', 'KRYTYCZNY BŁĄD KONFIGURACJI: Wymagany jest klucz Google Maps JavaScript API. Wklej go do pliku index.html.');
            } else {
                 displayMessage('default', 'Wprowadź adres i dystans, aby wyznaczyć pętlę.');
            }
        };

    </script>
</body>
</html>
